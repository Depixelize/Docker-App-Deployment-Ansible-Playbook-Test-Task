- name: Install MySQL Docker Container
  hosts: localhost
  become: true
  tasks:
    - name: Pull MySQL Docker Image
      docker_image:
        name: mysql:5.7
        source: pull
        state: present

    - name: Create MySQL Container
      docker_container:
        name: mysql
        image: mysql:5.7
        state: started
        ports:
          - "3306:3306"
        networks:
          - name: custom_network
            ipv4_address: 10.0.0.5
        volumes:
          - "/srv/mysql/conf:/etc/mysql/conf.d"
          - "/srv/mysql/logs:/var/log/mysql"
          - "/srv/mysql/mysqld:/var/run/mysqld"
        env:
          MYSQL_ROOT_PASSWORD: very_secret

    - name: Copy my cnf to mysql container
      command: docker cp ./my.cnf mysql:/root/

    - name: Pull Fluentd Docker Image
      docker_image:
        name: theasp/fluentd-plugins:all
        source: pull
        state: present

    - name: Create Fluentd Container
      docker_container:
        name: fluentd
        image: theasp/fluentd-plugins:all
        state: started
        ports:
          - "24224:24224"
        networks:
          - name: custom_network
            ipv4_address: 10.0.0.6
        volumes:
          - "/srv/fluentd/conf:/fluentd/etc"
          - "/srv/nginx/logs:/fluentd/log"

    - name: Copying Fluentd config
      template:
        src: fluent.conf
        dest: "/srv/fluentd/conf/fluent.conf"

    - name: Set password for root user
      mysql_user:
        name: "root"
        login_user: "root"
        login_password: "very_secret"
        password: "very_secret"
        config_file: "/root/my.cnf"
        priv: '*.*:ALL,GRANT'
        host: 'localhost'
        login_unix_socket: /srv/mysql/mysqld/mysqld.sock
        state: present
        
    - name: Create database
      mysql_db:
        name: log_db
        login_user: "root"
        login_password: "very_secret"
        config_file: "/root/my.cnf"
        login_unix_socket: /srv/mysql/mysqld/mysqld.sock
        state: present

    - name: Create table
      mysql_query:
        login_db: log_db
        login_user: "root"
        login_password: "very_secret"
        login_unix_socket: /srv/mysql/mysqld/mysqld.sock
        query: |
          CREATE TABLE IF NOT EXISTS log_table (
            remote_addr VARCHAR(45) NOT NULL,
            remote_user VARCHAR(255) NOT NULL,
            time_local DATETIME NOT NULL,
            request VARCHAR(255) NOT NULL,
            status INT NOT NULL,
            body_bytes_sent INT NOT NULL,
            referrer VARCHAR(255) NOT NULL,
            user_agent VARCHAR(255) NOT NULL,
            request_time FLOAT NOT NULL,
            upstream_response_time FLOAT NOT NULL,
            geoip_country_code VARCHAR(2) NOT NULL,
            PRIMARY KEY (time_local)
          );

    - name: Restart containers
      command: docker restart mysql fluentd
